<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>Stroop Test Â· NyPE</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Playfair+Display:wght@700;900&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap');

:root {
  --bg:        #0d0e12;
  --surface:   #161820;
  --border:    #252730;
  --accent:    #e8c547;
  --accent2:   #5b8dee;
  --muted:     #555870;
  --text:      #d8dae8;
  --text-dim:  #7e8198;
  --red:       #e85b5b;
  --green:     #4caf7d;
  --white-ink: #f0f0f0;
  --gold:      #e8c547;
  --silver:    #a0a8c0;
  --bronze:    #cd7f32;
  --radius:    12px;
  --tr:        0.2s cubic-bezier(0.4,0,0.2,1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; -webkit-text-size-adjust: 100%; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100dvh;
  display: flex; align-items: flex-start; justify-content: center;
  overflow-x: hidden; touch-action: manipulation;
}
body.trial-active { overflow: hidden; }
html.trial-active { overflow: hidden; }

body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background:
    radial-gradient(ellipse 80% 50% at 50% -10%, rgba(91,141,238,.09) 0%, transparent 70%),
    radial-gradient(ellipse 60% 40% at 80% 110%, rgba(232,197,71,.05) 0%, transparent 60%);
}

/* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen { display: none; width: 100%; max-width: 900px; padding: 36px 18px 56px; animation: fadeUp .35s ease both; position: relative; z-index: 1; }
.screen.active { display: block; }
@keyframes fadeUp { from { opacity:0; transform:translateY(14px) } to { opacity:1; transform:none } }

/* Trial screen â€” fixed, no scroll possible */
#screen-trial {
  display: none; flex-direction: column; align-items: center; justify-content: space-between;
  height: 100dvh; max-height: 100dvh;
  padding: 28px 18px 20px; padding-bottom: max(20px, env(safe-area-inset-bottom));
  text-align: center; position: fixed; inset: 0; z-index: 10;
  background: var(--bg); overflow: hidden;
}
#screen-trial.active { display: flex; }

/* â”€â”€ COMMON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-badge {
  display: inline-flex; align-items: center; gap: 8px;
  font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: .12em;
  color: var(--accent); text-transform: uppercase;
  border: 1px solid rgba(232,197,71,.25); padding: 6px 14px; border-radius: 100px; margin-bottom: 20px;
}
.lab-badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: blink 2s ease infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

h1 { font-family: 'Playfair Display', serif; font-size: clamp(2rem, 8vw, 3.4rem); font-weight: 900; line-height: 1.08; color: #fff; margin-bottom: 12px; letter-spacing: -.02em; }
h1 span { color: var(--accent); }
.subtitle { color: var(--text-dim); font-size: clamp(.88rem,3vw,1rem); line-height: 1.6; max-width: 520px; margin-bottom: 24px; }

.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 14px; }
.card-title { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: .14em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; }

.key-row { display: flex; gap: 10px; flex-wrap: wrap; }
.key-pill { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,.04); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; font-size: clamp(.85rem,3vw,.95rem); }
.key-num  { font-family: 'DM Mono', monospace; font-size: .85rem; font-weight: 500; background: rgba(255,255,255,.08); border-radius: 6px; padding: 2px 8px; color: var(--accent); }
.dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
.dot-red   { background: var(--red); }
.dot-green { background: var(--green); }
.dot-white { background: var(--white-ink); border: 1px solid #444; }

.field { margin-bottom: 4px; }
label { display: block; font-size: .82rem; color: var(--text-dim); margin-bottom: 6px; }
input[type="text"] {
  width: 100%; background: rgba(255,255,255,.04); border: 1px solid var(--border);
  border-radius: 8px; padding: 13px 16px; color: var(--text);
  font-family: 'DM Mono', monospace; font-size: 16px;
  outline: none; transition: border-color var(--tr); -webkit-appearance: none;
}
input[type="text"]:focus { border-color: var(--accent2); }

.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  padding: 15px 28px; border-radius: 9px; font-size: clamp(.9rem,3.5vw,.95rem); font-weight: 500;
  cursor: pointer; border: none; transition: all var(--tr);
  -webkit-appearance: none; touch-action: manipulation; user-select: none; min-height: 52px;
}
.btn-primary   { background: var(--accent); color: #0d0e12; width: 100%; }
.btn-primary:active { background: #f0d060; transform: scale(.98); }
.btn-secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
.btn-secondary:active { opacity: .7; }
.btn-sm { padding: 11px 20px; font-size: .85rem; min-height: 44px; }
.btn-share {
  background: linear-gradient(135deg, #25d366, #128c7e);
  color: #fff; width: 100%; font-size: 1rem;
}
.btn-share:active { opacity: .85; transform: scale(.98); }

/* â”€â”€ INSTRUCTIONS DEMO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.demo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 4px; }
.demo-card { border-radius: 10px; padding: 14px 12px; text-align: center; }
.demo-card.ok  { background: rgba(76,175,125,.08); border: 1px solid rgba(76,175,125,.2); }
.demo-card.bad { background: rgba(232,91,91,.08);  border: 1px solid rgba(232,91,91,.2); }
.demo-tag { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: .12em; text-transform: uppercase; margin-bottom: 8px; }
.demo-tag.ok  { color: var(--green); }
.demo-tag.bad { color: var(--red); }
.demo-word { font-family: 'Playfair Display', serif; font-size: clamp(1.5rem,5vw,2.2rem); font-weight: 900; line-height: 1; margin-bottom: 6px; }
.demo-caption { font-size: .72rem; color: var(--text-dim); line-height: 1.4; }

.step-list { display: flex; flex-direction: column; gap: 10px; }
.step { display: flex; align-items: flex-start; gap: 12px; }
.step-num { flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%; background: rgba(232,197,71,.15); border: 1px solid rgba(232,197,71,.3); color: var(--accent); font-family: 'DM Mono', monospace; font-size: .75rem; font-weight: 500; display: flex; align-items: center; justify-content: center; margin-top: 1px; }
.step-text { font-size: .88rem; color: var(--text-dim); line-height: 1.5; }
.step-text strong { color: var(--text); }

/* â”€â”€ PRACTICE BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.practice-badge {
  font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: .12em; text-transform: uppercase;
  color: var(--accent2); background: rgba(91,141,238,.12); border: 1px solid rgba(91,141,238,.25);
  padding: 4px 12px; border-radius: 100px;
}

/* â”€â”€ TRANSITION OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#transition-overlay {
  display: none; position: fixed; inset: 0; z-index: 20;
  background: var(--bg); flex-direction: column; align-items: center; justify-content: center;
  text-align: center; padding: 24px;
}
#transition-overlay.active { display: flex; }
.transition-title { font-family: 'Playfair Display', serif; font-size: clamp(1.8rem,6vw,2.8rem); font-weight: 900; color: #fff; margin-bottom: 12px; }
.transition-sub   { color: var(--text-dim); font-size: clamp(.9rem,3vw,1rem); max-width: 400px; line-height: 1.6; margin-bottom: 32px; }
.countdown { font-family: 'Playfair Display', serif; font-size: 5rem; font-weight: 900; color: var(--accent); line-height: 1; }

/* â”€â”€ TRIAL SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress-bar-wrap { width: 100%; max-width: 500px; flex-shrink: 0; }
.progress-meta { display: flex; justify-content: center; align-items: center; gap: 10px; font-family: 'DM Mono', monospace; font-size: 13px; color: var(--muted); margin-bottom: 8px; letter-spacing: .06em; }
.progress-track { height: 2px; background: var(--border); border-radius: 2px; overflow: hidden; }
.progress-fill  { height: 100%; background: var(--accent); border-radius: 2px; transition: width .3s ease; }

.stimulus-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-height: 0; }
.fixation { font-size: clamp(2.5rem,10vw,4rem); color: var(--muted); line-height: 1; animation: fixIn .5s ease; }
@keyframes fixIn { from{opacity:0;transform:scale(.75)} to{opacity:1;transform:scale(1)} }
.stimulus-word { font-family: 'Playfair Display', serif; font-size: clamp(2.8rem,11vw,5.5rem); font-weight: 900; letter-spacing: -.02em; line-height: 1; text-shadow: 0 2px 32px rgba(0,0,0,.5); animation: wordIn .15s ease both; }
@keyframes wordIn { from{opacity:0;transform:scale(.92)} to{opacity:1;transform:scale(1)} }

.response-area { width: 100%; max-width: 460px; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
.response-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.res-btn {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 8px; padding: 14px 8px; background: var(--surface); border: 1.5px solid var(--border);
  border-radius: 12px; cursor: pointer; transition: all .12s;
  user-select: none; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 74px;
}
.res-btn:active, .res-btn.pressed { transform: scale(.93); border-color: var(--accent2); background: rgba(91,141,238,.12); }
.res-btn .rnum { font-family: 'DM Mono', monospace; font-size: .78rem; color: var(--muted); }
.res-btn .rdot { width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; }
.keyboard-hint { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); text-align: center; letter-spacing: .06em; }

.feedback-flash { position: fixed; inset: 0; pointer-events: none; z-index: 200; opacity: 0; transition: opacity .08s; }
.feedback-flash.correct   { background: rgba(76,175,125,.1); }
.feedback-flash.incorrect { background: rgba(232,91,91,.15); }
.feedback-flash.show      { opacity: 1; }

/* â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.flex-between { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; }

.score-hero { background: linear-gradient(135deg, rgba(232,197,71,.12), rgba(232,197,71,.04)); border: 1px solid rgba(232,197,71,.3); border-radius: var(--radius); padding: 24px; margin-bottom: 14px; text-align: center; }
.score-label   { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: .14em; text-transform: uppercase; color: var(--accent); margin-bottom: 8px; }
.score-value   { font-family: 'Playfair Display', serif; font-size: clamp(3rem,10vw,4.5rem); font-weight: 900; color: var(--accent); line-height: 1; }
.score-sub     { font-size: .8rem; color: var(--text-dim); margin-top: 8px; }
.score-formula { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); margin-top: 6px; }

.results-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin-bottom: 14px; }
@media (max-width:400px) { .results-grid { grid-template-columns: 1fr; } }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; }
.stat-label { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: .12em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
.stat-value { font-family: 'Playfair Display', serif; font-size: clamp(1.6rem,6vw,2rem); font-weight: 700; color: #fff; }
.stat-unit  { font-size: .8rem; color: var(--text-dim); font-family: 'DM Sans', sans-serif; }
.stat-sub   { font-size: .72rem; color: var(--text-dim); margin-top: 4px; line-height: 1.4; }
.stat-hist  { font-size: .72rem; color: var(--accent); margin-top: 4px; }
.interference-card { background: linear-gradient(135deg,rgba(232,197,71,.08),rgba(232,197,71,.02)); border-color: rgba(232,197,71,.2); }
.interference-card .stat-value { color: var(--accent); }

.chart-wrap  { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; margin-bottom: 12px; }
.chart-title { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: .12em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; }
.chart-container { position: relative; height: 220px; }

/* â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
.lb-title  { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: .14em; text-transform: uppercase; color: var(--muted); }
.lb-status { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }
.lb-status.ok   { color: var(--green); }
.lb-status.err  { color: var(--red); }
.lb-status.spin { color: var(--accent2); display: inline-block; animation: spin .8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg) } }

.lb-row { display: grid; grid-template-columns: 36px 1fr auto; align-items: center; gap: 10px; padding: 12px 14px; border-radius: 9px; margin-bottom: 6px; background: var(--surface); border: 1px solid var(--border); }
.lb-row.is-you { border-color: rgba(232,197,71,.4); background: linear-gradient(90deg,rgba(232,197,71,.07),transparent); }
.lb-row.rank-1 { border-color: rgba(232,197,71,.4); }
.lb-row.rank-2 { border-color: rgba(160,168,192,.25); }
.lb-row.rank-3 { border-color: rgba(205,127,50,.25); }
.lb-rank { font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 700; text-align: center; }
.lb-rank.r1 { color: var(--gold); }
.lb-rank.r2 { color: var(--silver); }
.lb-rank.r3 { color: var(--bronze); }
.lb-rank.rn { color: var(--muted); font-size: .9rem; font-family: 'DM Mono', monospace; }
.lb-info   { min-width: 0; }
.lb-name   { font-size: .9rem; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.you-badge { font-family: 'DM Mono', monospace; font-size: .62rem; color: var(--accent); background: rgba(232,197,71,.15); border: 1px solid rgba(232,197,71,.3); padding: 1px 5px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
.lb-meta   { font-size: .7rem; color: var(--text-dim); font-family: 'DM Mono', monospace; margin-top: 2px; }
.lb-score  { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 700; color: var(--text); white-space: nowrap; }
.lb-score.r1 { color: var(--gold); }
.lb-empty  { text-align: center; padding: 24px; color: var(--muted); font-size: .85rem; font-family: 'DM Mono', monospace; }

/* â”€â”€ SHARE TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text); font-size: .85rem; padding: 12px 20px; border-radius: 9px;
  font-family: 'DM Mono', monospace; z-index: 300;
  opacity: 0; transition: all .3s; white-space: nowrap; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.actions-row { display: flex; flex-direction: column; gap: 10px; margin-top: 18px; }

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.credit { margin-top: 28px; text-align: center; color: var(--muted); font-size: .7rem; line-height: 1.5; font-style: italic; }
</style>
</head>
<body>

<!-- â•â• SCREEN 1 Â· INICIO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-start" class="screen active">
  <div class="lab-badge">NyPE Â· Stroop Test</div>
  <h1>Efecto<br><span>Stroop</span></h1>
  <p class="subtitle">
    Un experimento clÃ¡sico de psicologÃ­a cognitiva sobre atenciÃ³n e interferencia.
  </p>

  <!-- Instrucciones visuales -->
  <div class="card">
    <div class="card-title">Â¿CÃ³mo funciona?</div>
    <div class="step-list">
      <div class="step">
        <div class="step-num">1</div>
        <div class="step-text">Vas a ver una <strong>palabra escrita en color</strong>. Tu tarea es identificar el <strong>color de la tinta</strong>, ignorando lo que dice la palabra.</div>
      </div>
      <div class="step">
        <div class="step-num">2</div>
        <div class="step-text">RespondÃ© usando los <strong>botones de abajo</strong> (o las teclas 1, 2, 3 en computadora). Rojo Â· Verde Â· Blanco.</div>
      </div>
      <div class="step">
        <div class="step-num">3</div>
        <div class="step-text">RespondÃ© lo mÃ¡s <strong>rÃ¡pido y preciso</strong> posible. Â¡GanÃ¡s mÃ¡s puntos cuanto mÃ¡s rÃ¡pido respondas!</div>
      </div>
    </div>
  </div>


  <!-- Teclas -->
  <div class="card">
    <div class="card-title">Botones / teclas de respuesta</div>
    <div class="key-row">
      <div class="key-pill"><span class="key-num">1</span><span class="dot dot-red"></span>Rojo</div>
      <div class="key-pill"><span class="key-num">2</span><span class="dot dot-green"></span>Verde</div>
      <div class="key-pill"><span class="key-num">3</span><span class="dot dot-white"></span>Blanco</div>
    </div>
  </div>

  <!-- Participante -->
  <div class="card">
    <div class="card-title">Participante</div>
    <div class="field">
      <label>Tu nombre o ID (aparecerÃ¡ en el ranking)</label>
      <input type="text" id="participant-id" placeholder=""
             maxlength="20" autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
  </div>

  <button class="btn btn-primary" onclick="startExperiment()">Comenzar â†’</button>
  <p style="margin-top:10px; text-align:center; color:var(--text-dim); font-size:.82rem;">4 ensayos de prÃ¡ctica + 24 ensayos reales Â· ~3 minutos</p>
  <p class="credit">Creado por Guillermo Solovey para<br>Neurociencia y PsicologÃ­a Experimental, UTDT.</p>
</div>


<!-- â•â• SCREEN 2 Â· TAREA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-trial" class="screen">
  <div class="progress-bar-wrap">
    <div class="progress-meta">
      <span id="practice-badge" class="practice-badge" style="display:none">PRÃCTICA</span>
      <span id="trial-num">1</span>&nbsp;/&nbsp;<span id="trial-total">24</span>
    </div>
    <div class="progress-track"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
  </div>

  <div class="stimulus-area">
    <div class="fixation" id="fixation">+</div>
    <div class="stimulus-word" id="stimulus" style="display:none"></div>
  </div>

  <div class="response-area">
    <div class="response-buttons">
      <button class="res-btn" id="rbtn1" onclick="recordResponse('1')" ontouchstart="">
        <span class="rnum">1</span><span class="rdot" style="background:var(--red)"></span>
      </button>
      <button class="res-btn" id="rbtn2" onclick="recordResponse('2')" ontouchstart="">
        <span class="rnum">2</span><span class="rdot" style="background:var(--green)"></span>
      </button>
      <button class="res-btn" id="rbtn3" onclick="recordResponse('3')" ontouchstart="">
        <span class="rnum">3</span><span class="rdot" style="background:var(--white-ink);border:1px solid #555;"></span>
      </button>
    </div>
    <div class="keyboard-hint">O presionÃ¡ las teclas 1 Â· 2 Â· 3</div>
  </div>
</div>

<!-- Transition overlay after practice -->
<div id="transition-overlay">
  <div class="transition-title">Â¡Listo para<br><span style="color:var(--accent)">empezar!</span></div>
  <p class="transition-sub">La prÃ¡ctica terminÃ³. Ahora comienzan los ensayos reales. SeguÃ­ respondiendo lo mÃ¡s rÃ¡pido y preciso posible.</p>
  <div class="countdown" id="countdown">3</div>
</div>

<div class="feedback-flash" id="feedback-flash"></div>


<!-- â•â• SCREEN 3 Â· RESULTADOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-results" class="screen">

  <div class="flex-between" style="margin-bottom:22px;">
    <div>
      <div class="lab-badge">Resultados</div>
      <h1 style="font-size:clamp(1.8rem,6vw,2.4rem); margin-bottom:4px;">Tu <span>desempeÃ±o</span></h1>
      <p id="participant-label" style="color:var(--text-dim); font-size:.82rem;"></p>
    </div>
  </div>

  <!-- Score -->
  <div class="score-hero">
    <div class="score-label">Puntaje total</div>
    <div class="score-value" id="res-score">0</div>
    <div class="score-sub"   id="res-score-rank"></div>
    <div class="score-formula">100 pts base + 400Â·e<sup>âˆ’TR/700</sup> por respuesta correcta</div>
  </div>

  <!-- Stats -->
  <div class="results-grid">
    <div class="stat-card">
      <div class="stat-label">TR Medio Â· Congruente</div>
      <div class="stat-value" id="res-rt-con">â€”</div>
      <div class="stat-unit">ms</div>
      <div class="stat-sub"  id="res-acc-con"></div>
      <div class="stat-hist" id="res-rt-con-hist"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">TR Medio Â· Incongruente</div>
      <div class="stat-value" id="res-rt-inc">â€”</div>
      <div class="stat-unit">ms</div>
      <div class="stat-sub"  id="res-acc-inc"></div>
      <div class="stat-hist" id="res-rt-inc-hist"></div>
    </div>
    <div class="stat-card interference-card">
      <div class="stat-label">Interferencia Stroop</div>
      <div class="stat-value" id="res-interference">â€”</div>
      <div class="stat-unit">ms (Inc âˆ’ Con)</div>
      <div class="stat-sub"  id="res-interference-hist"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">PrecisiÃ³n Global</div>
      <div class="stat-value" id="res-accuracy">â€”</div>
      <div class="stat-unit">%</div>
      <div class="stat-sub"  id="res-accuracy-hist"></div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="card" style="margin-bottom:14px;">
    <div class="lb-header">
      <div class="lb-title">ğŸ† Tabla de posiciones</div>
      <span class="lb-status" id="lb-status"></span>
    </div>
    <div id="lb-rows"></div>
  </div>

  <!-- Charts -->
  <div class="chart-wrap">
    <div class="chart-title">Tiempo de reacciÃ³n medio â€” TÃº vs. Promedio histÃ³rico (ms)</div>
    <div class="chart-container"><canvas id="chart-rt"></canvas></div>
  </div>
  <div class="chart-wrap">
    <div class="chart-title">PrecisiÃ³n por condiciÃ³n â€” TÃº vs. Promedio histÃ³rico (%)</div>
    <div class="chart-container"><canvas id="chart-acc"></canvas></div>
  </div>

  <div class="actions-row">
    <!-- Share button -->
    <button class="btn btn-share" onclick="shareResults()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
      Compartir mi puntaje
    </button>
    <button class="btn btn-primary" onclick="restartExperiment()">Nuevo intento â†’</button>
    <button class="btn btn-secondary" onclick="show('screen-info')" style="text-align:center;">Â¿QuerÃ©s saber mÃ¡s sobre el efecto Stroop?</button>
  </div>
</div>


<!-- â•â• SCREEN 4 Â· EXPLICACIÃ“N â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-info" class="screen">
  <div class="lab-badge">El efecto Stroop</div>
  <h1 style="font-size:clamp(1.8rem,6vw,2.6rem); margin-bottom:24px;">Â¿QuÃ© acabÃ¡s<br>de <span>experimentar</span>?</h1>

  <div class="card" style="margin-bottom:16px;">
    <div class="card-title">El fenÃ³meno</div>
    <p style="color:var(--text-dim); font-size:.95rem; line-height:1.75;">En 1935, el psicÃ³logo John Ridley Stroop publicÃ³ uno de los hallazgos mÃ¡s replicados de toda la psicologÃ­a cognitiva: cuando el nombre de un color estÃ¡ escrito en una tinta de color diferente, las personas tardan mÃ¡s en identificar el color de la tinta y cometen mÃ¡s errores. Ese aumento en el tiempo de reacciÃ³n â€”que probablemente notaste comparando tus propios resultadosâ€” se llama <strong style="color:var(--text)">efecto de interferencia Stroop</strong>.</p>
  </div>

  <div class="card" style="margin-bottom:16px;">
    <div class="card-title">Por quÃ© ocurre</div>
    <p style="color:var(--text-dim); font-size:.95rem; line-height:1.75;">Leer palabras es un proceso altamente automatizado: despuÃ©s de aÃ±os de prÃ¡ctica, el cerebro lo hace de forma casi involuntaria, sin esfuerzo consciente. Identificar un color, en cambio, requiere atenciÃ³n mÃ¡s deliberada. Cuando ambas informaciones entran en conflicto â€”la palabra dice "ROJO" pero la tinta es verdeâ€” el sistema cognitivo tiene que resolver esa competencia entre respuestas, lo que consume tiempo y recursos atencionales. Esta competencia ocurre en regiones del cÃ³rtex prefrontal, especialmente en la corteza cingulada anterior, que actÃºa como un Ã¡rbitro que detecta el conflicto y suprime la respuesta automÃ¡tica incorrecta.</p>
  </div>

  <div class="card" style="margin-bottom:28px;">
    <div class="card-title">Para quÃ© sirve</div>
    <p style="color:var(--text-dim); font-size:.95rem; line-height:1.75;">El test de Stroop se utiliza en neuropsicologÃ­a clÃ­nica para evaluar el <strong style="color:var(--text)">control inhibitorio</strong> y la <strong style="color:var(--text)">flexibilidad cognitiva</strong> â€”la capacidad de ignorar informaciÃ³n irrelevante y enfocarse en lo que importa. Variaciones de la tarea se usan para estudiar el envejecimiento cognitivo, el TDAH, trastornos del estado de Ã¡nimo y los efectos de distintas sustancias sobre la atenciÃ³n. El efecto es robusto y aparece en prÃ¡cticamente todas las culturas estudiadas, aunque su magnitud varÃ­a con la edad, el entrenamiento y el estado atencional del momento.</p>
  </div>

  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    <button class="btn btn-primary" onclick="restartExperiment()" style="flex:1; min-width:160px;">Nuevo intento â†’</button>
    <button class="btn btn-secondary btn-sm" onclick="show('screen-results')" style="flex:1; min-width:120px;">â† Volver</button>
  </div>
  <p class="credit">Creado por Guillermo Solovey para<br>Neurociencia y PsicologÃ­a Experimental, UTDT.</p>
</div>

<!-- Share toast -->
<div class="toast" id="toast">âœ“ Â¡Copiado al portapapeles!</div>


<!-- â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â”€â”€ SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SUPABASE_URL      = 'https://irryksaoygdklwtsjsru.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlycnlrc2FveWdka2x3dHNqc3J1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTM4MTcsImV4cCI6MjA4NzM4OTgxN30.T6_CzKKaU67eWI1k-3WZe2Vc-msjlcs2X5btav39sII';
const SUPABASE_ENABLED  = true;
const SB_HEADERS = { 'Content-Type':'application/json', 'apikey':SUPABASE_ANON_KEY, 'Authorization':'Bearer '+SUPABASE_ANON_KEY };
const SB_REST    = SUPABASE_URL + '/rest/v1/stroop_sessions';

/* â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const INK_COLORS = {
  'ROJO':   { css:'#e85b5b', key:'1', label:'Rojo'   },
  'VERDE':  { css:'#4caf7d', key:'2', label:'Verde'  },
  'BLANCO': { css:'#f0f0f0', key:'3', label:'Blanco' }
};
const WORDS          = ['ROJO','VERDE','BLANCO'];
const FIXATION_MS    = 500;
const TIMEOUT_MS     = 3000;
const ITI_MS         = 300;
const TOTAL_TRIALS   = 24;
const PRACTICE_COUNT = 4;
const HIST_KEY       = 'stroop_nype_v2';

/* â”€â”€ SCORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function trialScore(correct, rt_ms) {
  if(!correct || rt_ms === null) return 0;
  return 100 + Math.round(400 * Math.exp(-rt_ms / 700));
}

/* â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let trials = [], currentTrial = 0, trialData = [];
let practiceTrials = [], currentPractice = 0;
let isPractice     = false;
let stimulusStart  = 0, awaitingResponse = false, trialTimeout = null;
let sessionScore   = 0;

/* â”€â”€ BUILD TRIALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function shuffle(arr) {
  for(let i=arr.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  return arr;
}

function buildRealTrials() {
  const list = [];
  WORDS.forEach(w => { for(let i=0;i<4;i++) list.push({condition:'congruente', word:w, ink:INK_COLORS[w], correctKey:INK_COLORS[w].key}); });
  [
    {word:'VERDE',  ink:INK_COLORS['ROJO']},   {word:'BLANCO', ink:INK_COLORS['ROJO']},
    {word:'ROJO',   ink:INK_COLORS['VERDE']},  {word:'BLANCO', ink:INK_COLORS['VERDE']},
    {word:'ROJO',   ink:INK_COLORS['BLANCO']}, {word:'VERDE',  ink:INK_COLORS['BLANCO']},
  ].forEach(t => { for(let i=0;i<2;i++) list.push({condition:'incongruente', word:t.word, ink:t.ink, correctKey:t.ink.key}); });
  return shuffle(list);
}

function buildPracticeTrials() {
  // 2 congruentes + 2 incongruentes, uno de cada
  const con = shuffle([
    {condition:'congruente', word:'ROJO',  ink:INK_COLORS['ROJO'],  correctKey:'1'},
    {condition:'congruente', word:'VERDE', ink:INK_COLORS['VERDE'], correctKey:'2'},
    {condition:'congruente', word:'BLANCO',ink:INK_COLORS['BLANCO'],correctKey:'3'},
  ]).slice(0,2);
  const inc = shuffle([
    {condition:'incongruente', word:'VERDE',  ink:INK_COLORS['ROJO'],   correctKey:'1'},
    {condition:'incongruente', word:'ROJO',   ink:INK_COLORS['VERDE'],  correctKey:'2'},
    {condition:'incongruente', word:'ROJO',   ink:INK_COLORS['BLANCO'], correctKey:'3'},
    {condition:'incongruente', word:'BLANCO', ink:INK_COLORS['VERDE'],  correctKey:'2'},
  ]).slice(0,2);
  return shuffle([...con, ...inc]);
}

/* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  // Lock scroll only during trial
  const lock = (id === 'screen-trial');
  document.body.classList.toggle('trial-active', lock);
  document.documentElement.classList.toggle('trial-active', lock);
  if(!lock) window.scrollTo(0, 0);
}

/* â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startExperiment() {
  practiceTrials  = buildPracticeTrials();
  trials          = buildRealTrials();
  trialData       = [];
  currentPractice = 0;
  currentTrial    = 0;
  sessionScore    = 0;
  isPractice      = true;

  document.getElementById('practice-badge').style.display = 'inline';
  document.getElementById('trial-total').textContent = PRACTICE_COUNT;
  document.getElementById('progress-fill').style.background = 'var(--accent2)';

  show('screen-trial');
  setBtns(false);
  runTrial();
}

function setBtns(on) {
  ['rbtn1','rbtn2','rbtn3'].forEach(id => {
    const el = document.getElementById(id);
    el.style.opacity = on ? '1' : '0.3';
    el.style.pointerEvents = on ? 'auto' : 'none';
  });
}

/* â”€â”€ TRIAL LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function runTrial() {
  if(isPractice) {
    if(currentPractice >= practiceTrials.length) {
      startTransition(); return;
    }
    const t = practiceTrials[currentPractice];
    document.getElementById('trial-num').textContent     = currentPractice + 1;
    document.getElementById('progress-fill').style.width = ((currentPractice+1)/PRACTICE_COUNT*100)+'%';
    showStimulus(t);
  } else {
    if(currentTrial >= trials.length) { endExperiment(); return; }
    const t = trials[currentTrial];
    document.getElementById('trial-num').textContent     = currentTrial + 1;
    document.getElementById('progress-fill').style.width = ((currentTrial+1)/TOTAL_TRIALS*100)+'%';
    showStimulus(t);
  }
}

function showStimulus(t) {
  const fix = document.getElementById('fixation'), stim = document.getElementById('stimulus');
  fix.style.display = 'block'; stim.style.display = 'none';
  awaitingResponse = false; setBtns(false);
  setTimeout(() => {
    fix.style.display  = 'none';
    stim.textContent   = t.word;
    stim.style.color   = t.ink.css;
    stim.style.display = 'block';
    stimulusStart = performance.now();
    awaitingResponse = true; setBtns(true);
    trialTimeout = setTimeout(() => recordResponse(null), TIMEOUT_MS);
  }, FIXATION_MS);
}

/* â”€â”€ TRANSITION BETWEEN PRACTICE AND REAL â”€â”€ */
function startTransition() {
  // Hide trial screen, show overlay
  document.getElementById('screen-trial').classList.remove('active');
  const overlay = document.getElementById('transition-overlay');
  overlay.classList.add('active');
  let n = 3;
  document.getElementById('countdown').textContent = n;
  const iv = setInterval(() => {
    n--;
    if(n > 0) {
      document.getElementById('countdown').textContent = n;
    } else {
      clearInterval(iv);
      overlay.classList.remove('active');
      // Switch to real trials
      isPractice = false;
      document.getElementById('practice-badge').style.display = 'none';
      document.getElementById('trial-total').textContent = TOTAL_TRIALS;
      document.getElementById('progress-fill').style.background = 'var(--accent)';
      document.getElementById('progress-fill').style.width = '0%';
      show('screen-trial');
      setBtns(false);
      runTrial();
    }
  }, 1000);
}

/* â”€â”€ RECORD RESPONSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function recordResponse(key) {
  if(!awaitingResponse) return;
  awaitingResponse = false;
  clearTimeout(trialTimeout);
  setBtns(false);

  const rt      = Math.round(performance.now() - stimulusStart);
  const t       = isPractice ? practiceTrials[currentPractice] : trials[currentTrial];
  const correct = key !== null && key === t.correctKey;

  if(key !== null) {
    showFeedback(correct);
    const el = document.getElementById('rbtn'+key);
    if(el) { el.classList.add('pressed'); setTimeout(()=>el.classList.remove('pressed'), 180); }
  }

  if(isPractice) {
    // Practice: feedback only, no data saved
    currentPractice++;
  } else {
    // Real trial: save data
    const pts = trialScore(correct, key !== null ? rt : null);
    sessionScore += pts;
    trialData.push({
      trial_index:  currentTrial + 1,
      condition:    t.condition,
      word:         t.word,
      ink_color:    t.ink.label,
      correct_key:  t.correctKey,
      response_key: key ?? 'timeout',
      correct:      key === null ? false : correct,
      rt_ms:        key === null ? null : rt,
      score_pts:    pts,
      timestamp:    new Date().toISOString()
    });
    currentTrial++;
  }

  setTimeout(runTrial, ITI_MS);
}

function showFeedback(ok) {
  const el = document.getElementById('feedback-flash');
  el.className = 'feedback-flash '+(ok?'correct':'incorrect')+' show';
  setTimeout(()=>el.classList.remove('show'), 180);
}

/* â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('keydown', e => {
  if(!awaitingResponse) return;
  if(['1','2','3'].includes(e.key)) recordResponse(e.key);
});

/* â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function computeStats(data) {
  const mean = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : null;
  const con   = data.filter(d=>d.condition==='congruente');
  const inc   = data.filter(d=>d.condition==='incongruente');
  const conRT = con.filter(d=>d.correct&&d.rt_ms!==null).map(d=>d.rt_ms);
  const incRT = inc.filter(d=>d.correct&&d.rt_ms!==null).map(d=>d.rt_ms);
  const mCon  = mean(conRT), mInc = mean(incRT);
  return {
    rt_con:       mCon!==null ? Math.round(mCon) : null,
    rt_inc:       mInc!==null ? Math.round(mInc) : null,
    acc_con:      con.length ? Math.round(con.filter(d=>d.correct).length/con.length*100) : 0,
    acc_inc:      inc.length ? Math.round(inc.filter(d=>d.correct).length/inc.length*100) : 0,
    acc_all:      data.length ? Math.round(data.filter(d=>d.correct).length/data.length*100) : 0,
    interference: mCon!==null&&mInc!==null ? Math.round(mInc-mCon) : null,
    total_score:  sessionScore,
    n_correct:    data.filter(d=>d.correct).length
  };
}

/* â”€â”€ LOCAL HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadLocalHist() { try { const r=localStorage.getItem(HIST_KEY); return r?JSON.parse(r):[]; } catch{return[];} }
function saveLocalHist(s) {
  try { let h=loadLocalHist(); h.push({...s,ts:Date.now()}); if(h.length>500) h=h.slice(-500); localStorage.setItem(HIST_KEY,JSON.stringify(h)); } catch(e){}
}
function histMeans(h) {
  if(!h||!h.length) return null;
  const mean = arr=>arr.filter(v=>v!==null).reduce((a,b)=>a+b,0)/arr.filter(v=>v!==null).length;
  return { rt_con:Math.round(mean(h.map(x=>x.rt_con))), rt_inc:Math.round(mean(h.map(x=>x.rt_inc))), acc_con:Math.round(mean(h.map(x=>x.acc_con))), acc_inc:Math.round(mean(h.map(x=>x.acc_inc))), interference:Math.round(mean(h.map(x=>x.interference))), acc_all:Math.round(mean(h.map(x=>x.acc_all))), n:h.length };
}

/* â”€â”€ SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function saveToSupabase(pid, stats) {
  if(!SUPABASE_ENABLED) return null;
  try {
    const res = await fetch(SB_REST, { method:'POST', headers:{...SB_HEADERS,'Prefer':'return=minimal'}, body:JSON.stringify({participant_id:pid||'AnÃ³nimo', rt_con:stats.rt_con, rt_inc:stats.rt_inc, acc_con:stats.acc_con, acc_inc:stats.acc_inc, acc_all:stats.acc_all, interference:stats.interference, total_score:stats.total_score, n_correct:stats.n_correct}) });
    if(!res.ok) { const t=await res.text(); console.warn('Supabase insert error:',res.status,t); return null; }
    return true;
  } catch(e) { console.warn('Supabase insert exception:',e.message); return null; }
}

async function loadLeaderboard() {
  if(!SUPABASE_ENABLED) return null;
  try {
    const res = await fetch(SB_REST+'?select=participant_id,total_score,rt_con,rt_inc,acc_all&order=total_score.desc&limit=10', { headers:SB_HEADERS });
    if(!res.ok) { const t=await res.text(); console.warn('Supabase select error:',res.status,t); return null; }
    return await res.json();
  } catch(e) { console.warn('Supabase select exception:',e.message); return null; }
}

async function loadSupabaseHist() {
  if(!SUPABASE_ENABLED) return null;
  try {
    const res = await fetch(SB_REST+'?select=rt_con,rt_inc,acc_con,acc_inc,acc_all,interference', { headers:SB_HEADERS });
    if(!res.ok) return null;
    const data = await res.json();
    if(!data?.length) return null;
    const mean = arr=>arr.filter(v=>v!==null).reduce((a,b)=>a+b,0)/arr.filter(v=>v!==null).length;
    return { rt_con:Math.round(mean(data.map(x=>x.rt_con))), rt_inc:Math.round(mean(data.map(x=>x.rt_inc))), acc_con:Math.round(mean(data.map(x=>x.acc_con))), acc_inc:Math.round(mean(data.map(x=>x.acc_inc))), interference:Math.round(mean(data.map(x=>x.interference))), acc_all:Math.round(mean(data.map(x=>x.acc_all))), n:data.length };
  } catch(e) { return null; }
}

/* â”€â”€ LEADERBOARD RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderLeaderboard(rows, currentPid, currentScore) {
  const container = document.getElementById('lb-rows');
  const status    = document.getElementById('lb-status');
  if(!rows||!rows.length) { container.innerHTML='<div class="lb-empty">TodavÃ­a no hay registros.<br>Â¡SÃ© el primero!</div>'; status.textContent=''; status.className='lb-status'; return; }
  status.textContent = rows.length+' participantes'; status.className = 'lb-status ok';
  container.innerHTML = '';
  rows.forEach((row,i) => {
    const rank = i+1;
    const isMe = currentPid && row.participant_id===currentPid && row.total_score===currentScore;
    const rankMap = {1:['r1','ğŸ¥‡'],2:['r2','ğŸ¥ˆ'],3:['r3','ğŸ¥‰']};
    const [rankCls, rankSymbol] = rankMap[rank] ?? ['rn', rank];
    const div = document.createElement('div');
    div.className = 'lb-row'+(isMe?' is-you':'')+' rank-'+Math.min(rank,4);
    div.innerHTML = `<div class="lb-rank ${rankCls}">${rankSymbol}</div><div class="lb-info"><div class="lb-name">${esc(row.participant_id)}${isMe?'<span class="you-badge">TÃš</span>':''}</div><div class="lb-meta">${row.acc_all}% Â· con ${row.rt_con??'â€”'}ms / inc ${row.rt_inc??'â€”'}ms</div></div><div class="lb-score ${rank===1?'r1':''}">${row.total_score.toLocaleString()}</div>`;
    container.appendChild(div);
    if(isMe) { const el=document.getElementById('res-score-rank'); if(el) el.textContent='PosiciÃ³n #'+rank+' en el ranking'; }
  });
}

function esc(str) { return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* â”€â”€ END EXPERIMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let rtChart=null, accChart=null;

async function endExperiment() {
  show('screen-results');
  const s   = computeStats(trialData);
  const pid = document.getElementById('participant-id').value.trim() || 'AnÃ³nimo';
  document.getElementById('participant-label').textContent = 'Participante: '+pid;
  document.getElementById('res-score').textContent = s.total_score.toLocaleString();
  saveLocalHist(s);

  const lbStatus = document.getElementById('lb-status');
  let hm = null;
  if(SUPABASE_ENABLED) {
    lbStatus.textContent = 'âŸ³'; lbStatus.className = 'lb-status spin';
    try {
      await saveToSupabase(pid, s);
      const [lbRows, sbHist] = await Promise.all([loadLeaderboard(), loadSupabaseHist()]);
      hm = sbHist;
      renderLeaderboard(lbRows, pid, s.total_score);
    } catch(e) {
      lbStatus.textContent = 'Error de conexiÃ³n'; lbStatus.className = 'lb-status err';
      hm = histMeans(loadLocalHist());
      document.getElementById('lb-rows').innerHTML = '<div class="lb-empty">No se pudo conectar. VerificÃ¡ tu conexiÃ³n.</div>';
    }
  } else {
    hm = histMeans(loadLocalHist());
    lbStatus.textContent = 'sin conexiÃ³n'; lbStatus.className = 'lb-status err';
    document.getElementById('lb-rows').innerHTML = '<div class="lb-empty">Supabase no configurado.</div>';
  }

  const fmt  = v => v!==null ? v : 'â€”';
  const sign = v => v!==null ? (v>=0?'+'+v:''+v) : 'â€”';
  document.getElementById('res-rt-con').textContent       = fmt(s.rt_con);
  document.getElementById('res-rt-inc').textContent       = fmt(s.rt_inc);
  document.getElementById('res-acc-con').textContent      = 'PrecisiÃ³n: '+s.acc_con+'%';
  document.getElementById('res-acc-inc').textContent      = 'PrecisiÃ³n: '+s.acc_inc+'%';
  document.getElementById('res-interference').textContent = sign(s.interference);
  document.getElementById('res-accuracy').textContent     = s.acc_all;

  if(hm && hm.n > 1) {
    document.getElementById('res-rt-con-hist').textContent    = 'Promedio (n='+hm.n+'): '+hm.rt_con+' ms';
    document.getElementById('res-rt-inc-hist').textContent    = 'Promedio (n='+hm.n+'): '+hm.rt_inc+' ms';
    document.getElementById('res-interference-hist').textContent = 'Promedio (n='+hm.n+'): '+sign(hm.interference)+' ms';
    document.getElementById('res-accuracy-hist').textContent  = 'Promedio: '+hm.acc_all+'%';
  } else {
    document.getElementById('res-interference-hist').textContent = 'Primera sesiÃ³n registrada';
  }

  drawCharts(s, hm && hm.n > 1 ? hm : null);
}

/* â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function drawCharts(s, hm) {
  const base = { responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#7e8198',font:{family:"'DM Mono',monospace",size:11},boxWidth:12,padding:12}},tooltip:{backgroundColor:'#161820',borderColor:'#252730',borderWidth:1,titleColor:'#d8dae8',bodyColor:'#7e8198',titleFont:{family:"'Playfair Display',serif",size:13},bodyFont:{family:"'DM Mono',monospace",size:11}}}, scales:{x:{ticks:{color:'#7e8198',font:{family:"'DM Mono',monospace",size:11}},grid:{color:'#1e2030'}},y:{ticks:{color:'#7e8198',font:{family:"'DM Mono',monospace",size:11}},grid:{color:'#1e2030'}}} };
  const labels = ['Congruente','Incongruente'];
  if(rtChart)  { rtChart.destroy();  rtChart=null; }
  if(accChart) { accChart.destroy(); accChart=null; }

  const rtDS = [{label:'TÃº',data:[s.rt_con,s.rt_inc],backgroundColor:['rgba(91,141,238,.8)','rgba(91,141,238,.45)'],borderColor:'rgba(91,141,238,1)',borderWidth:1.5,borderRadius:6}];
  if(hm) rtDS.push({label:'Promedio (n='+hm.n+')',data:[hm.rt_con,hm.rt_inc],backgroundColor:['rgba(232,197,71,.65)','rgba(232,197,71,.35)'],borderColor:'rgba(232,197,71,1)',borderWidth:1.5,borderRadius:6});
  rtChart = new Chart(document.getElementById('chart-rt'),{type:'bar',data:{labels,datasets:rtDS},options:{...base,scales:{...base.scales,y:{...base.scales.y,title:{display:true,text:'ms',color:'#555870',font:{size:10}}}}}});

  const accDS = [{label:'TÃº',data:[s.acc_con,s.acc_inc],backgroundColor:['rgba(76,175,125,.8)','rgba(76,175,125,.45)'],borderColor:'rgba(76,175,125,1)',borderWidth:1.5,borderRadius:6}];
  if(hm) accDS.push({label:'Promedio (n='+hm.n+')',data:[hm.acc_con,hm.acc_inc],backgroundColor:['rgba(232,197,71,.65)','rgba(232,197,71,.35)'],borderColor:'rgba(232,197,71,1)',borderWidth:1.5,borderRadius:6});
  accChart = new Chart(document.getElementById('chart-acc'),{type:'bar',data:{labels,datasets:accDS},options:{...base,scales:{...base.scales,y:{...base.scales.y,min:0,max:100,title:{display:true,text:'%',color:'#555870',font:{size:10}}}}}});
}

/* â”€â”€ SHARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function shareResults() {
  const pid   = document.getElementById('participant-id').value.trim() || 'AnÃ³nimo';
  const score = sessionScore.toLocaleString();
  const url   = window.location.href.split('?')[0];
  const text  = `ğŸ§  Hice el Test de Stroop y obtuve ${score} puntos!\nÂ¿PodÃ©s superarme?\nğŸ‘‰ ${url}`;

  if(navigator.share) {
    try { await navigator.share({ title:'Test de Stroop Â· NyPE', text }); return; }
    catch(e) { if(e.name === 'AbortError') return; }
  }
  // Fallback: copy to clipboard
  try {
    await navigator.clipboard.writeText(text);
    showToast('âœ“ Â¡Copiado al portapapeles!');
  } catch {
    showToast('CopiÃ¡ el link manualmente');
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2800);
}

/* â”€â”€ RESTART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function restartExperiment() {
  document.getElementById('participant-id').value = '';
  show('screen-start');
}
</script>
</body>
</html>
