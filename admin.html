<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ¬∑ Stroop NyPE</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap');

:root {
  --bg:#0d0e12; --surface:#161820; --border:#252730; --accent:#e8c547;
  --accent2:#5b8dee; --muted:#555870; --text:#d8dae8; --text-dim:#7e8198;
  --red:#e85b5b; --green:#4caf7d; --gold:#e8c547; --silver:#a0a8c0; --bronze:#cd7f32;
  --radius:12px;
}
*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; padding:32px 18px 56px; }
body::before { content:''; position:fixed; inset:0; pointer-events:none; background:radial-gradient(ellipse 80% 50% at 50% -10%,rgba(91,141,238,.08) 0%,transparent 70%); z-index:0; }

.wrap { max-width:900px; margin:0 auto; position:relative; z-index:1; }

.lab-badge { display:inline-flex; align-items:center; gap:8px; font-family:'DM Mono',monospace; font-size:11px; letter-spacing:.12em; color:var(--accent); text-transform:uppercase; border:1px solid rgba(232,197,71,.25); padding:6px 14px; border-radius:100px; margin-bottom:20px; }
.lab-badge::before { content:''; width:6px; height:6px; border-radius:50%; background:var(--accent); animation:blink 2s ease infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

h1 { font-family:'Playfair Display',serif; font-size:clamp(1.8rem,5vw,2.8rem); font-weight:900; color:#fff; margin-bottom:6px; letter-spacing:-.02em; }
h1 span { color:var(--accent); }
.page-sub { color:var(--text-dim); font-size:.88rem; margin-bottom:28px; }

.card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:22px; margin-bottom:14px; }
.card-title { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.14em; text-transform:uppercase; color:var(--muted); margin-bottom:14px; }

/* N sessions */
.n-pill { display:inline-flex; align-items:baseline; gap:12px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px 24px; margin-bottom:16px; }
.n-label { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); }
.n-value { font-family:'Playfair Display',serif; font-size:2.2rem; font-weight:700; color:#fff; }

/* Charts */
.charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:14px; }
@media (max-width:560px) { .charts-grid { grid-template-columns:1fr; } }
.chart-wrap  { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; }
.chart-title { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:14px; }
.chart-h { position:relative; height:200px; }

/* Controls */
.controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:20px; }
.btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:11px 22px; border-radius:9px; font-size:.88rem; font-weight:500; cursor:pointer; border:none; transition:all .2s; min-height:44px; font-family:'DM Sans',sans-serif; }
.btn-primary   { background:var(--accent); color:#0d0e12; }
.btn-primary:hover { background:#f0d060; }
.btn-secondary { background:transparent; color:var(--text); border:1px solid var(--border); }
.btn-secondary:hover { border-color:var(--text-dim); }
.btn-danger    { color:var(--red); border:1px solid rgba(232,91,91,.3); background:transparent; }
.btn-danger:hover { background:rgba(232,91,91,.06); }

.status-line { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); padding:4px 0; }
.status-line.ok  { color:var(--green); }
.status-line.err { color:var(--red); }
@keyframes spin { to{transform:rotate(360deg)} }
.spin { display:inline-block; animation:spin .8s linear infinite; }

/* Password modal */
.modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:100; align-items:center; justify-content:center; padding:24px; }
.modal-bg.active { display:flex; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:28px; width:100%; max-width:360px; animation:fadeUp .2s ease; }
@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:none} }
.modal h2 { font-family:'Playfair Display',serif; font-size:1.4rem; color:#fff; margin-bottom:8px; }
.modal p  { font-size:.85rem; color:var(--text-dim); margin-bottom:18px; line-height:1.5; }
.modal input { width:100%; background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:8px; padding:12px 14px; color:var(--text); font-family:'DM Mono',monospace; font-size:15px; outline:none; transition:border-color .2s; margin-bottom:10px; }
.modal input:focus { border-color:var(--accent2); }
.modal-err  { font-family:'DM Mono',monospace; font-size:11px; color:var(--red); min-height:18px; margin-bottom:12px; }
.modal-btns { display:flex; gap:10px; }
.modal-btns .btn { flex:1; }

/* Leaderboard */
.lb-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:8px; }
.lb-title  { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.14em; text-transform:uppercase; color:var(--muted); }
.lb-status { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); }
.lb-status.ok { color:var(--green); }

.lb-row { display:grid; grid-template-columns:36px 1fr auto; align-items:center; gap:10px; padding:12px 14px; border-radius:9px; margin-bottom:6px; background:var(--surface); border:1px solid var(--border); }
.lb-row.rank-1 { border-color:rgba(232,197,71,.4); }
.lb-row.rank-2 { border-color:rgba(160,168,192,.25); }
.lb-row.rank-3 { border-color:rgba(205,127,50,.25); }
.lb-rank { font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:700; text-align:center; }
.lb-rank.r1 { color:var(--gold); }
.lb-rank.r2 { color:var(--silver); }
.lb-rank.r3 { color:var(--bronze); }
.lb-rank.rn { color:var(--muted); font-size:.9rem; font-family:'DM Mono',monospace; }
.lb-info { min-width:0; }
.lb-name { font-size:.9rem; font-weight:500; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.lb-meta { font-size:.7rem; color:var(--text-dim); font-family:'DM Mono',monospace; margin-top:2px; }
.lb-score { font-family:'Playfair Display',serif; font-size:1.3rem; font-weight:700; color:var(--text); white-space:nowrap; }
.lb-score.r1 { color:var(--gold); }
.lb-empty { text-align:center; padding:24px; color:var(--muted); font-size:.85rem; font-family:'DM Mono',monospace; }

::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
</style>
</head>
<body>
<div class="wrap">

  <div class="lab-badge">NyPE ¬∑ Admin</div>
  <h1>Panel de <span>resultados</span></h1>
  <p class="page-sub">Resumen agregado de todas las sesiones ¬∑ Acceso solo para el experimentador</p>

  <div class="controls">
    <button class="btn btn-primary"   onclick="loadData()">‚Üª Actualizar</button>
    <button class="btn btn-secondary" onclick="exportCSV()">Exportar CSV</button>
    <button class="btn btn-danger"    onclick="openModal()">Borrar todos los datos</button>
    <span class="status-line" id="status">‚Äî</span>
  </div>

  <!-- N sessions -->
  <div class="n-pill">
    <span class="n-label">Sesiones registradas</span>
    <span class="n-value" id="s-n">‚Äî</span>
  </div>

  <!-- 2 charts -->
  <div class="charts-grid">
    <div class="chart-wrap">
      <div class="chart-title">TR medio por condici√≥n (ms)</div>
      <div class="chart-h"><canvas id="chart-rt"></canvas></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-title">Precisi√≥n por condici√≥n (%)</div>
      <div class="chart-h"><canvas id="chart-acc"></canvas></div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="card">
    <div class="lb-header">
      <div class="lb-title">üèÜ Tabla de posiciones</div>
      <span class="lb-status" id="lb-status"></span>
    </div>
    <div id="lb-rows"></div>
  </div>

</div>

<!-- Password modal -->
<div class="modal-bg" id="modal-bg">
  <div class="modal">
    <h2>Confirmar borrado</h2>
    <p>Esta acci√≥n elimina permanentemente <strong style="color:var(--text)" id="modal-n"></strong>. Ingres√° la contrase√±a de administrador para continuar.</p>
    <input type="password" id="modal-pwd" placeholder="Contrase√±a"
           onkeydown="if(event.key==='Enter') doDelete()">
    <div class="modal-err" id="modal-err"></div>
    <div class="modal-btns">
      <button class="btn btn-danger"    onclick="doDelete()">Borrar</button>
      <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚öôÔ∏è  CONFIGURACI√ìN
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SUPABASE_URL      = 'https://irryksaoygdklwtsjsru.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlycnlrc2FveWdka2x3dHNqc3J1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTM4MTcsImV4cCI6MjA4NzM4OTgxN30.T6_CzKKaU67eWI1k-3WZe2Vc-msjlcs2X5btav39sII';

// ‚Üê Cambi√° esto por la contrase√±a que quieras usar
const ADMIN_PASSWORD = 'nype2025';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const SB_HEADERS = { 'Content-Type':'application/json', 'apikey':SUPABASE_ANON_KEY, 'Authorization':'Bearer '+SUPABASE_ANON_KEY };
const SB_REST    = SUPABASE_URL + '/rest/v1/stroop_sessions';

let allData = [], rtChart = null, accChart = null;

const baseOpts = {
  responsive:true, maintainAspectRatio:false,
  plugins:{ legend:{display:false}, tooltip:{backgroundColor:'#161820',borderColor:'#252730',borderWidth:1,titleColor:'#d8dae8',bodyColor:'#7e8198',titleFont:{family:"'DM Mono',monospace",size:11},bodyFont:{family:"'DM Mono',monospace",size:11}} },
  scales:{ x:{ticks:{color:'#7e8198',font:{family:"'DM Mono',monospace",size:11}},grid:{color:'#1e2030'}}, y:{ticks:{color:'#7e8198',font:{family:"'DM Mono',monospace",size:11}},grid:{color:'#1e2030'}} }
};

/* ‚îÄ‚îÄ LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadData() {
  const status = document.getElementById('status');
  status.textContent = '‚ü≥'; status.className = 'status-line spin';
  try {
    const res = await fetch(SB_REST+'?select=*&order=total_score.desc', { headers:SB_HEADERS });
    if(!res.ok) throw new Error('HTTP '+res.status+': '+await res.text());
    allData = await res.json();
    status.textContent = allData.length+' sesiones cargadas'; status.className = 'status-line ok';
    renderAll();
  } catch(e) {
    status.textContent = 'Error: '+e.message; status.className = 'status-line err';
  }
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function mean(arr) {
  const v = arr.filter(x => x !== null && x !== undefined);
  return v.length ? v.reduce((a,b)=>a+b,0)/v.length : null;
}

function renderAll() {
  document.getElementById('s-n').textContent = allData.length;

  const rtCon  = mean(allData.map(d=>d.rt_con));
  const rtInc  = mean(allData.map(d=>d.rt_inc));
  const accCon = mean(allData.map(d=>d.acc_con));
  const accInc = mean(allData.map(d=>d.acc_inc));

  // Charts
  if(rtChart)  { rtChart.destroy();  rtChart=null; }
  if(accChart) { accChart.destroy(); accChart=null; }

  rtChart = new Chart(document.getElementById('chart-rt'), {
    type:'bar',
    data:{ labels:['Congruente','Incongruente'], datasets:[{ data:[rtCon?Math.round(rtCon):null, rtInc?Math.round(rtInc):null], backgroundColor:['rgba(91,141,238,.8)','rgba(91,141,238,.4)'], borderColor:'rgba(91,141,238,1)', borderWidth:1.5, borderRadius:6 }] },
    options:{...baseOpts, scales:{...baseOpts.scales, y:{...baseOpts.scales.y, title:{display:true,text:'ms',color:'#555870',font:{size:10}}}}}
  });

  accChart = new Chart(document.getElementById('chart-acc'), {
    type:'bar',
    data:{ labels:['Congruente','Incongruente'], datasets:[{ data:[accCon?Math.round(accCon):null, accInc?Math.round(accInc):null], backgroundColor:['rgba(76,175,125,.8)','rgba(76,175,125,.4)'], borderColor:'rgba(76,175,125,1)', borderWidth:1.5, borderRadius:6 }] },
    options:{...baseOpts, scales:{...baseOpts.scales, y:{...baseOpts.scales.y, min:0, max:100, title:{display:true,text:'%',color:'#555870',font:{size:10}}}}}
  });

  // Leaderboard (top 10)
  const container = document.getElementById('lb-rows');
  const lbStatus  = document.getElementById('lb-status');
  const rows = allData.slice(0, 10);

  if(!rows.length) {
    container.innerHTML = '<div class="lb-empty">Todav√≠a no hay sesiones registradas.</div>';
    lbStatus.textContent = ''; return;
  }

  lbStatus.textContent = 'top ' + rows.length + ' de ' + allData.length;
  lbStatus.className = 'lb-status ok';
  container.innerHTML = '';

  rows.forEach((row, i) => {
    const rank = i + 1;
    const rankMap = {1:['r1','ü•á'], 2:['r2','ü•à'], 3:['r3','ü•â']};
    const [rankCls, rankSymbol] = rankMap[rank] ?? ['rn', rank];
    const div = document.createElement('div');
    div.className = 'lb-row rank-' + Math.min(rank, 4);
    div.innerHTML = `
      <div class="lb-rank ${rankCls}">${rankSymbol}</div>
      <div class="lb-info">
        <div class="lb-name">${esc(row.participant_id)}</div>
        <div class="lb-meta">${row.acc_all ?? '‚Äî'}% ¬∑ con ${row.rt_con ?? '‚Äî'} ms / inc ${row.rt_inc ?? '‚Äî'} ms</div>
      </div>
      <div class="lb-score ${rank===1?'r1':''}">${(row.total_score||0).toLocaleString()}</div>
    `;
    container.appendChild(div);
  });
}

/* ‚îÄ‚îÄ CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function exportCSV() {
  if(!allData.length) { alert('No hay datos cargados.'); return; }
  const header = ['participant_id','total_score','rt_con','rt_inc','interference','acc_con','acc_inc','acc_all','n_correct','created_at'];
  const rows   = allData.map(d => header.map(k => JSON.stringify(d[k]??'')).join(','));
  const blob   = new Blob([[header.join(','), ...rows].join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'stroop_admin_'+Date.now()+'.csv'; a.click();
}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function openModal() {
  if(!allData.length) { alert('No hay datos para borrar.'); return; }
  document.getElementById('modal-n').textContent = allData.length + ' sesiones';
  document.getElementById('modal-pwd').value = '';
  document.getElementById('modal-err').textContent = '';
  document.getElementById('modal-bg').classList.add('active');
  setTimeout(() => document.getElementById('modal-pwd').focus(), 120);
}

function closeModal() {
  document.getElementById('modal-bg').classList.remove('active');
}

document.getElementById('modal-bg').addEventListener('click', e => {
  if(e.target === document.getElementById('modal-bg')) closeModal();
});

async function doDelete() {
  const pwd = document.getElementById('modal-pwd').value;
  if(pwd !== ADMIN_PASSWORD) {
    document.getElementById('modal-err').textContent = 'Contrase√±a incorrecta.';
    document.getElementById('modal-pwd').value = '';
    document.getElementById('modal-pwd').focus();
    return;
  }

  closeModal();
  const status = document.getElementById('status');
  status.textContent = 'Borrando‚Ä¶'; status.className = 'status-line';

  try {
    const res = await fetch(SB_REST+'?id=neq.00000000-0000-0000-0000-000000000000', { method:'DELETE', headers:SB_HEADERS });
    if(!res.ok) throw new Error('HTTP '+res.status);
    allData = [];
    document.getElementById('s-n').textContent = '0';
    document.getElementById('lb-rows').innerHTML = '<div class="lb-empty">Sin datos.</div>';
    document.getElementById('lb-status').textContent = '';
    if(rtChart)  { rtChart.destroy();  rtChart=null; }
    if(accChart) { accChart.destroy(); accChart=null; }
    status.textContent = 'Datos borrados correctamente.'; status.className = 'status-line ok';
  } catch(e) {
    status.textContent = 'Error al borrar: '+e.message; status.className = 'status-line err';
  }
}

function esc(str) { return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

loadData();
</script>
</body>
</html>
