<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin · Stroop NyPE</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap');

:root {
  --bg:#0d0e12; --surface:#161820; --border:#252730; --accent:#e8c547;
  --accent2:#5b8dee; --muted:#555870; --text:#d8dae8; --text-dim:#7e8198;
  --red:#e85b5b; --green:#4caf7d; --gold:#e8c547; --silver:#a0a8c0; --bronze:#cd7f32;
  --radius:12px;
}
*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; padding:32px 18px 56px; }
body::before { content:''; position:fixed; inset:0; pointer-events:none; background:radial-gradient(ellipse 80% 50% at 50% -10%,rgba(91,141,238,.08) 0%,transparent 70%); z-index:0; }

.wrap { max-width:1000px; margin:0 auto; position:relative; z-index:1; }

.lab-badge { display:inline-flex; align-items:center; gap:8px; font-family:'DM Mono',monospace; font-size:11px; letter-spacing:.12em; color:var(--accent); text-transform:uppercase; border:1px solid rgba(232,197,71,.25); padding:6px 14px; border-radius:100px; margin-bottom:20px; }
.lab-badge::before { content:''; width:6px; height:6px; border-radius:50%; background:var(--accent); animation:blink 2s ease infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

h1 { font-family:'Playfair Display',serif; font-size:clamp(1.8rem,5vw,2.8rem); font-weight:900; color:#fff; margin-bottom:6px; letter-spacing:-.02em; }
h1 span { color:var(--accent); }
.page-sub { color:var(--text-dim); font-size:.88rem; margin-bottom:28px; }

.card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:22px; margin-bottom:14px; }
.card-title { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.14em; text-transform:uppercase; color:var(--muted); margin-bottom:14px; }

/* Summary grid */
.summary-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:16px; }
.stat { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; }
.stat-label { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:8px; }
.stat-value { font-family:'Playfair Display',serif; font-size:2rem; font-weight:700; color:#fff; }
.stat-unit  { font-size:.78rem; color:var(--text-dim); margin-top:2px; }
.stroop-stat .stat-value { color:var(--accent); }

/* Charts */
.charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:16px; }
@media (max-width:600px) { .charts-grid { grid-template-columns:1fr; } }
.chart-wrap  { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; }
.chart-title { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:14px; }
.chart-h { position:relative; height:200px; }

/* Sessions table */
.table-wrap { overflow-x:auto; border-radius:8px; border:1px solid var(--border); -webkit-overflow-scrolling:touch; }
table { width:100%; border-collapse:collapse; font-size:.78rem; min-width:700px; }
thead { background:#1b1d25; position:sticky; top:0; z-index:1; }
th { padding:10px 12px; text-align:left; font-family:'DM Mono',monospace; font-size:8.5px; letter-spacing:.1em; text-transform:uppercase; color:var(--muted); border-bottom:1px solid var(--border); white-space:nowrap; }
td { padding:9px 12px; border-bottom:1px solid rgba(37,39,48,.6); font-family:'DM Mono',monospace; white-space:nowrap; }
tr:last-child td { border-bottom:none; }
tr.highlight { background:rgba(232,197,71,.04); }
.badge-con  { color:var(--green); }
.badge-inc  { color:var(--red); }
.score-col  { color:var(--accent); font-weight:500; }

/* Controls */
.controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:18px; }
.btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:11px 22px; border-radius:9px; font-size:.88rem; font-weight:500; cursor:pointer; border:none; transition:all .2s; min-height:44px; font-family:'DM Sans',sans-serif; }
.btn-primary { background:var(--accent); color:#0d0e12; }
.btn-primary:hover { background:#f0d060; }
.btn-secondary { background:transparent; color:var(--text); border:1px solid var(--border); }
.btn-secondary:hover { border-color:var(--text-dim); }
.btn-danger { color:var(--red); border:1px solid rgba(232,91,91,.3); background:transparent; }
.btn-danger:hover { background:rgba(232,91,91,.06); }

.status-line { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); padding:4px 0; }
.status-line.ok  { color:var(--green); }
.status-line.err { color:var(--red); }

.spinner { display:inline-block; animation:spin .8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }

/* Distribution bars */
.dist-wrap { display:flex; flex-direction:column; gap:6px; }
.dist-row { display:flex; align-items:center; gap:8px; }
.dist-label { font-family:'DM Mono',monospace; font-size:10px; color:var(--text-dim); width:56px; flex-shrink:0; }
.dist-bar-bg { flex:1; height:10px; background:rgba(255,255,255,.05); border-radius:3px; overflow:hidden; }
.dist-bar-fill { height:100%; border-radius:3px; background:var(--accent2); transition:width .4s ease; }
.dist-count { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); width:28px; text-align:right; flex-shrink:0; }

::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
</style>
</head>
<body>
<div class="wrap">

  <div class="lab-badge">NyPE · Admin</div>
  <h1>Panel de <span>resultados</span></h1>
  <p class="page-sub">Resumen agregado de todas las sesiones · Acceso solo para el experimentador</p>

  <div class="controls">
    <button class="btn btn-primary" onclick="loadData()">↻ Actualizar datos</button>
    <button class="btn btn-secondary" onclick="exportCSV()">Exportar CSV completo</button>
    <button class="btn btn-danger"   onclick="confirmClear()">Borrar todos los datos</button>
    <span class="status-line" id="status">—</span>
  </div>

  <!-- Summary -->
  <div class="summary-grid" id="summary-grid">
    <div class="stat"><div class="stat-label">Sesiones totales</div><div class="stat-value" id="s-n">—</div></div>
    <div class="stat"><div class="stat-label">TR medio · Congruente</div><div class="stat-value" id="s-rt-con">—</div><div class="stat-unit">ms</div></div>
    <div class="stat"><div class="stat-label">TR medio · Incongruente</div><div class="stat-value" id="s-rt-inc">—</div><div class="stat-unit">ms</div></div>
    <div class="stat stroop-stat"><div class="stat-label">Interferencia Stroop</div><div class="stat-value" id="s-interf">—</div><div class="stat-unit">ms (Inc − Con)</div></div>
    <div class="stat"><div class="stat-label">Precisión · Congruente</div><div class="stat-value" id="s-acc-con">—</div><div class="stat-unit">%</div></div>
    <div class="stat"><div class="stat-label">Precisión · Incongruente</div><div class="stat-value" id="s-acc-inc">—</div><div class="stat-unit">%</div></div>
    <div class="stat"><div class="stat-label">Puntaje promedio</div><div class="stat-value" id="s-score">—</div></div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-wrap">
      <div class="chart-title">TR medio por condición (ms)</div>
      <div class="chart-h"><canvas id="chart-rt"></canvas></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-title">Precisión por condición (%)</div>
      <div class="chart-h"><canvas id="chart-acc"></canvas></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-title">Distribución de interferencia Stroop (ms)</div>
      <div class="chart-h"><canvas id="chart-interf"></canvas></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-title">Distribución de puntajes</div>
      <div class="chart-h"><canvas id="chart-scores"></canvas></div>
    </div>
  </div>

  <!-- Sessions table -->
  <div class="card">
    <div class="card-title" id="table-title">Todas las sesiones</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Participante</th><th>Puntaje</th>
            <th>TR con (ms)</th><th>TR inc (ms)</th><th>Interferencia</th>
            <th>Prec. con</th><th>Prec. inc</th><th>Prec. global</th><th>Fecha</th>
          </tr>
        </thead>
        <tbody id="sessions-tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const SUPABASE_URL      = 'https://irryksaoygdklwtsjsru.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlycnlrc2FveWdka2x3dHNqc3J1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTM4MTcsImV4cCI6MjA4NzM4OTgxN30.T6_CzKKaU67eWI1k-3WZe2Vc-msjlcs2X5btav39sII';
const SB_HEADERS = { 'Content-Type':'application/json', 'apikey':SUPABASE_ANON_KEY, 'Authorization':'Bearer '+SUPABASE_ANON_KEY };
const SB_REST    = SUPABASE_URL + '/rest/v1/stroop_sessions';

let allData = [];
let rtChart=null, accChart=null, interfChart=null, scoreChart=null;

const baseChartOpts = {
  responsive:true, maintainAspectRatio:false,
  plugins:{ legend:{labels:{color:'#7e8198',font:{family:"'DM Mono',monospace",size:11},boxWidth:12,padding:10}}, tooltip:{backgroundColor:'#161820',borderColor:'#252730',borderWidth:1,titleColor:'#d8dae8',bodyColor:'#7e8198',titleFont:{family:"'DM Mono',monospace",size:11},bodyFont:{family:"'DM Mono',monospace",size:11}} },
  scales:{ x:{ticks:{color:'#7e8198',font:{family:"'DM Mono',monospace",size:11}},grid:{color:'#1e2030'}}, y:{ticks:{color:'#7e8198',font:{family:"'DM Mono',monospace",size:11}},grid:{color:'#1e2030'}} }
};

async function loadData() {
  const status = document.getElementById('status');
  status.textContent = '⟳ Cargando…'; status.className = 'status-line spinner';

  try {
    // Load all rows ordered by date desc, no limit
    const res = await fetch(SB_REST+'?select=*&order=created_at.desc', { headers:SB_HEADERS });
    if(!res.ok) throw new Error('HTTP '+res.status+': '+await res.text());
    allData = await res.json();

    status.textContent = allData.length+' sesiones cargadas'; status.className = 'status-line ok';
    renderAll();
  } catch(e) {
    status.textContent = 'Error: '+e.message; status.className = 'status-line err';
  }
}

function mean(arr) { const v=arr.filter(x=>x!==null&&x!==undefined); return v.length ? v.reduce((a,b)=>a+b,0)/v.length : null; }
function fmt(v,dec=0) { return v!==null&&v!==undefined ? v.toFixed(dec) : '—'; }

function renderAll() {
  if(!allData.length) return;

  const n      = allData.length;
  const rtCon  = mean(allData.map(d=>d.rt_con));
  const rtInc  = mean(allData.map(d=>d.rt_inc));
  const interf = mean(allData.map(d=>d.interference));
  const accCon = mean(allData.map(d=>d.acc_con));
  const accInc = mean(allData.map(d=>d.acc_inc));
  const score  = mean(allData.map(d=>d.total_score));

  document.getElementById('s-n').textContent      = n;
  document.getElementById('s-rt-con').textContent = fmt(rtCon);
  document.getElementById('s-rt-inc').textContent = fmt(rtInc);
  document.getElementById('s-interf').textContent = interf!==null ? (interf>=0?'+':'')+fmt(interf) : '—';
  document.getElementById('s-acc-con').textContent= fmt(accCon);
  document.getElementById('s-acc-inc').textContent= fmt(accInc);
  document.getElementById('s-score').textContent  = fmt(score);

  document.getElementById('table-title').textContent = 'Todas las sesiones ('+n+')';

  drawCharts(rtCon, rtInc, accCon, accInc);
  drawDistributions();
  renderTable();
}

function drawCharts(rtCon, rtInc, accCon, accInc) {
  if(rtChart)    { rtChart.destroy();    rtChart=null; }
  if(accChart)   { accChart.destroy();   accChart=null; }

  rtChart = new Chart(document.getElementById('chart-rt'),{
    type:'bar',
    data:{ labels:['Congruente','Incongruente'], datasets:[{ data:[rtCon,rtInc], backgroundColor:['rgba(91,141,238,.8)','rgba(91,141,238,.4)'], borderColor:'rgba(91,141,238,1)', borderWidth:1.5, borderRadius:6 }] },
    options:{...baseChartOpts, plugins:{...baseChartOpts.plugins,legend:{display:false}}, scales:{...baseChartOpts.scales, y:{...baseChartOpts.scales.y, title:{display:true,text:'ms',color:'#555870',font:{size:10}}}}}
  });

  accChart = new Chart(document.getElementById('chart-acc'),{
    type:'bar',
    data:{ labels:['Congruente','Incongruente'], datasets:[{ data:[accCon,accInc], backgroundColor:['rgba(76,175,125,.8)','rgba(76,175,125,.4)'], borderColor:'rgba(76,175,125,1)', borderWidth:1.5, borderRadius:6 }] },
    options:{...baseChartOpts, plugins:{...baseChartOpts.plugins,legend:{display:false}}, scales:{...baseChartOpts.scales, y:{...baseChartOpts.scales.y, min:0, max:100, title:{display:true,text:'%',color:'#555870',font:{size:10}}}}}
  });
}

function histogram(vals, bins, min, max) {
  const step = (max-min)/bins;
  const counts = Array(bins).fill(0);
  const labels = [];
  for(let i=0;i<bins;i++) labels.push(Math.round(min+i*step));
  vals.forEach(v => {
    if(v===null||v===undefined) return;
    const idx = Math.min(bins-1, Math.floor((v-min)/step));
    if(idx>=0) counts[idx]++;
  });
  return {labels, counts};
}

function drawDistributions() {
  if(interfChart) { interfChart.destroy(); interfChart=null; }
  if(scoreChart)  { scoreChart.destroy();  scoreChart=null; }

  const interfVals = allData.map(d=>d.interference).filter(v=>v!==null);
  const scoreVals  = allData.map(d=>d.total_score).filter(v=>v!==null);

  if(interfVals.length > 1) {
    const {labels,counts} = histogram(interfVals, 10, Math.min(...interfVals)-10, Math.max(...interfVals)+10);
    interfChart = new Chart(document.getElementById('chart-interf'),{
      type:'bar',
      data:{labels, datasets:[{data:counts, backgroundColor:'rgba(232,197,71,.6)', borderColor:'rgba(232,197,71,1)', borderWidth:1, borderRadius:4}]},
      options:{...baseChartOpts, plugins:{...baseChartOpts.plugins,legend:{display:false}}, scales:{...baseChartOpts.scales, x:{...baseChartOpts.scales.x, title:{display:true,text:'ms',color:'#555870',font:{size:10}}}, y:{...baseChartOpts.scales.y, title:{display:true,text:'n',color:'#555870',font:{size:10}}}}}
    });
  }

  if(scoreVals.length > 1) {
    const {labels,counts} = histogram(scoreVals, 10, Math.min(...scoreVals)-50, Math.max(...scoreVals)+50);
    scoreChart = new Chart(document.getElementById('chart-scores'),{
      type:'bar',
      data:{labels, datasets:[{data:counts, backgroundColor:'rgba(91,141,238,.6)', borderColor:'rgba(91,141,238,1)', borderWidth:1, borderRadius:4}]},
      options:{...baseChartOpts, plugins:{...baseChartOpts.plugins,legend:{display:false}}, scales:{...baseChartOpts.scales, y:{...baseChartOpts.scales.y, title:{display:true,text:'n',color:'#555870',font:{size:10}}}}}
    });
  }
}

function renderTable() {
  const tbody = document.getElementById('sessions-tbody');
  tbody.innerHTML = '';
  allData.forEach((d,i) => {
    const tr = document.createElement('tr');
    if(i===0) tr.className='highlight';
    const date = new Date(d.created_at).toLocaleString('es-AR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
    const interf = d.interference!==null ? (d.interference>=0?'+':'')+d.interference : '—';
    tr.innerHTML = `
      <td style="color:var(--muted)">${allData.length-i}</td>
      <td style="color:var(--text);font-weight:500">${esc(d.participant_id)}</td>
      <td class="score-col">${(d.total_score||0).toLocaleString()}</td>
      <td>${d.rt_con??'—'}</td>
      <td>${d.rt_inc??'—'}</td>
      <td style="color:${d.interference>0?'var(--accent)':'var(--green)'}">${interf}</td>
      <td>${d.acc_con??'—'}%</td>
      <td>${d.acc_inc??'—'}%</td>
      <td>${d.acc_all??'—'}%</td>
      <td style="color:var(--muted)">${date}</td>
    `;
    tbody.appendChild(tr);
  });
}

function exportCSV() {
  if(!allData.length) { alert('No hay datos cargados.'); return; }
  const header = ['participant_id','total_score','rt_con','rt_inc','interference','acc_con','acc_inc','acc_all','n_correct','created_at'];
  const rows = allData.map(d => header.map(k => JSON.stringify(d[k]??'')).join(','));
  const csv  = [header.join(','), ...rows].join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download = 'stroop_admin_'+Date.now()+'.csv'; a.click();
}

async function confirmClear() {
  const n = allData.length;
  if(!confirm(`⚠️ Vas a borrar TODAS las ${n} sesiones de Supabase.\nEsta acción es irreversible.\n\n¿Confirmás?`)) return;
  if(!confirm('Segunda confirmación: ¿borrar todos los datos?')) return;

  const status = document.getElementById('status');
  status.textContent = 'Borrando…'; status.className = 'status-line';
  try {
    // Delete all rows (filter on non-null id to affect all)
    const res = await fetch(SB_REST+'?id=neq.00000000-0000-0000-0000-000000000000', { method:'DELETE', headers:SB_HEADERS });
    if(!res.ok) throw new Error('HTTP '+res.status);
    allData = [];
    status.textContent = 'Datos borrados.'; status.className = 'status-line ok';
    document.getElementById('sessions-tbody').innerHTML = '';
    ['s-n','s-rt-con','s-rt-inc','s-interf','s-acc-con','s-acc-inc','s-score'].forEach(id=>document.getElementById(id).textContent='—');
  } catch(e) { status.textContent = 'Error al borrar: '+e.message; status.className = 'status-line err'; }
}

function esc(str) { return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Load on page open
loadData();
</script>
</body>
</html>
